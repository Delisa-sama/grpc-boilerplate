## Project structure
```
grpc-boilerplate
├── api
│   └── v1
│       ├── api.pb.go         // Generated gRPC server and client
│       ├── api.pb.gw.go      // Generated HTTP to gRPC-gateway
│       ├── api.proto         // Service gRPC specification (proto3)
│       ├── api.swagger.json  // Generated swagger schema
│       └── api.yaml          // Yaml HTTP api specification (needed to generate swagger and gateway)
├── config                    // Service configurations
│   └── config.go
├── controllers
│   ├── echo.go
│   └── memo.go
├── gateway                   // gRPC-gateway
│   └── entrypoint.go
├── migrations                // Your SQL migration files for sql-migrate
│   └── 001_memo.sql
├── models                    // Models generated by sqlboiler from your schema
│   ├── boil_queries.go
│   ├── boil_table_names.go
│   ├── boil_types.go
│   ├── memo.go
│   └── psql_upsert.go
├── service                   // Main service package - runnable
│   └── main.go
├── tools                     // Tools package - go.mod based tools management
│   └── tools.go
├── dbconfig.yml              // Database config-template, configuring via ENV variables
├── Dockerfile.gateway
├── Dockerfile.service
├── .gitignore
├── go.mod
├── go.sum
├── LICENSE
├── Makefile
├── README.md
└── sqlboiler.toml.example    // Configuration file described as an .example
```
## Install
* Prepare your database (create a new database and role)
* Clone or download repo
* Go into project directory and install dependencies
```shell script
$ make dependencies
```
* Install [protobuf compiler](https://github.com/google/protobuf/blob/master/README.md#protocol-compiler-installation) from binary or install from apt
```shell script
sudo apt install protobuf-compiler
```
* Install tools
 ```shell script
$ make tools
 ```
* (Optional) Rebuild the generated gRPC client and server, gateway and swagger schema
```shell script
$ make proto
```
* (Optional) Rebuild only gRPC-gateway
```shell script
$ make gateway-proto
```
* (Optional) Regenerate swagger only
```shell script
$ make docs-proto
```
* (Optional) Regenerate only gRPC client and server
```shell script
$ make service-proto
```
* Setup environment variables for your database
```shell script
export DB_HOST=<YOUR HOST>
export DB_NAME=<YOUR NAME OF DATABASE>
export DB_USER=<YOUR NAME OF ROLE>
export DB_PASSWORD=<YOUR ROLE PASSWORD>
```
* Run sql-migrate and check status of migrations
```shell script
$ make migrate
```
* Create sqlboiler configuration file from example (sqlboiler.toml.example)
```toml
output           = "models"
wipe             = true
no_tests         = false
no_context       = true
add_soft_deletes = true

[psql]
  dbname = "dbname"
  host   = "localhost"
  port   = 5432
  user   = "dbusername"
  pass   = "dbpassword"
  schema = "myschema"
  blacklist = ["migrations"]
```
* Run sqlboiler to generate models from your database schema
```shell script
$ make models
```

## Build binary
```shell script
$ make build
```

## Makefile features
- make proto - regenerate grpc client, server, gateway and swagger
- make migrate - apply migrations by sql-migrate
- make models - generate models from database schema by sqlbuiler
- make build - build gateway and service binaries
- make check - code static checks and tests
- make dependencies - go mod tidy
- make clean - delete all generated entities (models, swagger, go code, ...)
- make test - run go tests with cover report
- make tools - install all tool packages
- make benchmark - run benchmarks

## Run as binary
(Recommended) Put your environment variables into .env file
```.env
export DB_HOST=127.0.0.1
export DB_NAME=yourdbname
export DB_USER=yourdbuser
export DB_PASSWORD=yourdbpassword
export LOG_LEVEL=INFO
export APP_PORT=8080
```
Run the binary
```shell script
$ source .env
$ ./main
$ ./gateway
```

## Build as docker container
```shell script
$ sudo docker build -f Dockerfile.gateway .
$ sudo docker build -f Dockerfile.service .
```

## ENV variables
### Service
| ENV         | Status     | Description                                                                                             | Required | Defaults           |
|-------------|------------|---------------------------------------------------------------------------------------------------------|----------|--------------------|
| LOG_PATH    | Actual     | Path to log file. If putted filename only, log file will be created in the same directory as the binary | ✘        | "" - stdout        |
| LOG_LEVEL   | Actual     | Logging level [FATAL, ERROR, WARN, DEBUG, INFO, STASH]                                                  | ✘        | WARN               |
| APP_HOST    | Actual     | Address or addr-pattern what will listen to the application                                             | ✘        | "" - all addresses |
| APP_PORT    | Actual     | Application port                                                                                        | ✘        | 8080               |
| DB_DIALECT  | Actual     | The SQL dialect of your DBMS                                                                            | ✘        | postgres           |
| DB_HOST     | Actual     | DB address                                                                                              | ✓        |                    |
| DB_PORT     | Actual     | DB port                                                                                                 | ✓        |                    |
| DB_USER     | Actual     | DBMS name of the role                                                                                   | ✓        |                    |
| DB_PASSWORD | Actual     | DBMS auth password                                                                                      | ✓        |                    |
| DB_NAME     | Actual     | Name of the database                                                                                    | ✓        |                    |
| DB_CHARSET  | Deprecated | Charset of database                                                                                     |          |                    |

### Proxy
| ENV             | Status | Description                                             | Required | Defaults           |
|-----------------|--------|---------------------------------------------------------|----------|--------------------|
| ENTRYPOINT_HOST | Actual | Address or addr-pattern what will listen to the gateway | ✘        | "" - all addresses |
| ENTRYPOINT_PORT | Actual | Proxy port                                              | ✘        | 8080               |
| ENDPOINT_HOST   | Actual | Address of gRPC server (endpoint)                       | ✓        |                    |
| ENDPOINT_PORT   | Actual | gRPC server port                                        | ✓        |                    |
